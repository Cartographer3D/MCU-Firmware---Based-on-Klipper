# This file contains common pin mappings for STEVAL-3DP001V1 board.
# to use this config, the firmware should be compiled for the STM32F401ve

# See docs/Config_Reference.md for a description of parameters.
# Refer to https://www.st.com/en/motor-drivers/l6474.html for more info about the L6474 stepper driver


[stepper_x]
step_pin: PE14
dir_pin: !PE15
microsteps: 16
rotation_distance: 40
endstop_pin: ~!PD8
position_endstop: 0
position_max: 300
homing_speed: 50

[stepper_y]
step_pin: PB10
dir_pin: !PE9
microsteps: 16
rotation_distance: 40
endstop_pin: ~!PD9
position_endstop: 0
position_max: 255
homing_speed: 50

[stepper_z]
step_pin: PC6
dir_pin: PC0
microsteps: 16
rotation_distance: 8
endstop_pin: ~!PD10
position_endstop: 0
position_min: 0
position_max: 300

[extruder]
step_pin: PD12
dir_pin: PC13
microsteps: 16
rotation_distance: 7.921
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PC7
sensor_type: EPCOS 100K B57560G104F
pullup_resistor: 1000  # for steval board 1k pull up resistor is used
sensor_pin: PA0
control: pid
pid_Kp: 24.575
pid_Ki: 1.085
pid_Kd: 139.157
min_temp: 0
max_temp: 265

[heater_bed]
heater_pin: PD14
sensor_type: EPCOS 100K B57560G104F
pullup_resistor: 1000  # for steval board 1k pull up resistor is used
sensor_pin: PC2
control: pid
pid_Kp: 71.255
pid_Ki: 0.956
pid_Kd: 1328.008
min_temp: 0
max_temp: 95

#layer fan
[fan]
pin: PE8

[heater_fan extruder]
pin: PC4
heater : extruder

[mcu]
serial: /dev/serial/by-id/usb-STMicroelectronics_STM32_STLink_0674FF514852897267245621-if02
baud: 115200
restart_method: command

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000
max_z_velocity: 5
max_z_accel: 100

########################################
# L6474 (motor drivers) configuration
########################################

[L6474 stepper_x]
chain_length: 6
chain_position: 1
spi_bus: spi1
cs_pin: PA4

##  Default reg settings
# driver_TVAL: 20    #(656.25mA)
# driver_TOFF_FAST: 3 #(8us)  value used in Marlin4ST
# driver_FAST_STEP: 5  #(12us)   value used in Marlin4ST
# driver_TON_MIN: 5  #(3us)    value used in Marlin4ST
# driver_TOFF_MIN: 21 #(11us)  value used in Marlin4ST
# driver_OCD_TH: 2  #(1.125A)
# driver_STEP_SEL: 12  #(1/16) #default
# driver_SYNC_SEL: 8   # sync signal obtained starting from EL_POS[7]      (value used in Marlin4ST)

##  Alarm Enable Register
# driver_over_current: 1
# driver_thermal_shut: 1
# driver_thermal_warn: 1
# driver_under_voltage: 1
# driver_switch: 1
# driver_wrong:  1

##  Config Register
# driver_OSC_SEL: 0
# driver_EXT_CLK: 0
# driver_EN_TQREG: 0 #(internal)
# driver_OC_SD: 1
# driver_POW_SR: 0
# driver_TOFF: 11    #(48us)  value used in Marlin4ST

###############################################################

[L6474 stepper_y]
chain_length: 6
chain_position: 2
cs_pin: PA4

##  Default reg settings
# driver_TVAL: 20
# driver_TOFF_FAST: 3
# driver_FAST_STEP: 5
# driver_TON_MIN: 5
# driver_TOFF_MIN: 21
# driver_OCD_TH: 2
# driver_STEP_SEL: 12
# driver_SYNC_SEL: 8

##  Alarm Enable Register
# driver_over_current: 1
# driver_thermal_shut: 1
# driver_thermal_warn: 1
# driver_under_voltage: 1
# driver_switch: 1
# driver_wrong:  1

##  Config Register
# driver_OSC_SEL: 0
# driver_EXT_CLK: 0
# driver_EN_TQREG: 0
# driver_OC_SD: 1
# driver_POW_SR: 0
# driver_TOFF: 11

###############################################################

[L6474 stepper_z]
chain_length: 6
chain_position: 3
cs_pin: PA4

## Default reg settings
# driver_TVAL: 24
# driver_TOFF_FAST: 3
# driver_FAST_STEP: 5
# driver_TON_MIN: 5
# driver_TOFF_MIN: 21
# driver_OCD_TH: 2
# driver_STEP_SEL: 12
# driver_SYNC_SEL: 8

##  Alarm Enable Register
# driver_over_current: 1
# driver_thermal_shut: 1
# driver_thermal_warn: 1
# driver_under_voltage: 1
# driver_switch: 1
# driver_wrong:  1

##  Config Register
# driver_OSC_SEL: 0
# driver_EXT_CLK: 0
# driver_EN_TQREG: 0
# driver_OC_SD: 1
# driver_POW_SR: 0
# driver_TOFF: 11

###############################################################

[L6474 extruder]
chain_length: 6
chain_position: 4
cs_pin: PA4

##  Default reg settings
# driver_TVAL: 20
# driver_TOFF_FAST: 3
# driver_FAST_STEP: 5
# driver_TON_MIN: 5
# driver_TOFF_MIN: 21
# driver_OCD_TH: 2
# driver_STEP_SEL: 12
# driver_SYNC_SEL: 8

##  Alarm Enable Register
# driver_over_current: 1
# driver_thermal_shut: 1
# driver_thermal_warn: 1
# driver_under_voltage: 1
# driver_switch: 1
# driver_wrong:  1

##  Config Register
# driver_OSC_SEL: 0
# driver_EXT_CLK: 0
# driver_EN_TQREG: 0
# driver_OC_SD: 1
# driver_POW_SR: 0
# driver_TOFF: 11

###############################################################

[L6474 dummy1]
chain_length: 6
chain_position: 5
cs_pin: PA4

##  Default reg settings
# driver_TVAL: 7
# driver_TOFF_FAST: 3
# driver_FAST_STEP: 5
# driver_TON_MIN: 5
# driver_TOFF_MIN: 21
# driver_OCD_TH: 1
# driver_STEP_SEL: 12
# driver_SYNC_SEL: 8

##  Alarm Enable Register
# driver_over_current: 1
# driver_thermal_shut: 1
# driver_thermal_warn: 1
# driver_under_voltage: 1
# driver_switch: 1
# driver_wrong:  1

##  Config Register
# driver_OSC_SEL: 0
# driver_EXT_CLK: 0
# driver_EN_TQREG: 0
# driver_OC_SD: 1
# driver_POW_SR: 0
# driver_TOFF: 11

###############################################################

[L6474 dummy2]
chain_length: 6
chain_position: 6
cs_pin: PA4

##  Default register settings
# driver_TVAL: 7
# driver_TOFF_FAST: 3
# driver_FAST_STEP: 5
# driver_TON_MIN: 5
# driver_TOFF_MIN: 21
# driver_OCD_TH: 1
# driver_STEP_SEL: 12
# driver_SYNC_SEL: 8

##  Alarm Enable Register
# driver_over_current: 1
# driver_thermal_shut: 1
# driver_thermal_warn: 1
# driver_under_voltage: 1
# driver_switch: 1
# driver_wrong:  1

##  Config Register
# driver_OSC_SEL: 0
# driver_EXT_CLK: 0
# driver_EN_TQREG: 0
# driver_OC_SD: 1
# driver_POW_SR: 0
# driver_TOFF: 11

########################################
# L6474 Reset pin handler
########################################

[output_pin rst_stepper_x]
pin: PE13
pwm: False
value: 1
shutdown_value: 0

[output_pin rst_stepper_y]
pin: PE10
pwm: False
value: 1
shutdown_value: 0

[output_pin rst_stepper_z]
pin: PC15
pwm: False
value: 1
shutdown_value: 0

[output_pin rst_extruder1]
pin: PC14
pwm: False
value: 1
shutdown_value: 0

[output_pin rst_extruder2]
pin: PE4
pwm: False
value: 1
shutdown_value: 0

[output_pin rst_extruder3]
pin: PE3
pwm: False
value: 1
shutdown_value: 0
