# This file contains common pin mappings for the Velleman K8400 using a
# 3Drag based mainboard. To use this config, the firmware should be compiled for the AVR atmega2560.
# Information is based on original config from the Marlin software, this is for the dual extruder variant. I'm not using the original hotends so your x_offset might vary https://wiki.e3d-online.com/E3D-v6_on_Velleman_K8400
# one should remove the homing section in his config (this is a temporary fix since my x-endstop is broken)

[stepper_x]
step_pin: ar54
dir_pin: ar55
enable_pin: !ar38
#step_distance: .0125
step_distance: 0.00742170 #1/134.74 from marlin config DEFAULT_AXIS_STEPS_PER_UNIT
endstop_pin: ^!ar3
position_endstop: 0
position_max: 165
homing_speed: 50

[stepper_y]
step_pin: ar60
dir_pin: !ar61
enable_pin: !ar56
step_distance: 0.00742170 #1/134.74 from marlin config DEFAULT_AXIS_STEPS_PER_UNIT
endstop_pin: ^!ar14
position_endstop: 0
position_max: 170
homing_speed: 50

[stepper_z]
step_pin: ar46
dir_pin: !ar48
enable_pin: !ar63
step_distance: 0.000234375 # 1รท4266.66
endstop_pin: ^!ar18
position_endstop: 0.5
position_max: 190

[extruder]
step_pin: ar26
dir_pin: ar28
enable_pin: !ar24
step_distance: 0.0065 #.001333
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: ar10
sensor_type: ATC Semitec 104GT-2
sensor_pin: analog13
#control: pid
#pid_Kp: 21.503
#pid_Ki: 1.103
#pid_Kd: 104.825
min_temp: 0
max_temp: 250

[gcode_macro T0]
gcode:
    SET_GCODE_OFFSET Z=0.2 MOVE=1                 # Adjust z-height
    SET_GCODE_OFFSET X=0                        # Clear X offset
    ACTIVATE_EXTRUDER EXTRUDER=extruder

[extruder1]
step_pin:ar32
dir_pin:!ar34
enable_pin: !ar30
step_distance: 0.00660
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: ar11
sensor_type: ATC Semitec 104GT-2
sensor_pin: analog15
#control: pid
#pid_Kp: 21.503
#pid_Ki: 1.103
#pid_Kd: 104.825
min_temp: 0
max_temp: 250

[gcode_macro T1]
gcode:
    SET_GCODE_OFFSET Z=0.22 MOVE=1             # Adjust z-height
    SET_GCODE_OFFSET X=-32.8                        # Account for different X offset
    ACTIVATE_EXTRUDER EXTRUDER=extruder1



[heater_bed]
heater_pin: ar9 #or ar6?
sensor_type: ATC Semitec 104GT-2
sensor_pin: analog14
control: watermark
min_temp: 0
max_temp: 130

[fan]
pin: ar8
kick_start_time: 0.500

[heater_fan test]
pin: ar2
heater: extruder,extruder1,heater_bed
heater_temp: 35

[mcu]
serial: /dev/serial/by-id/usb-FTDI_FT232R_USB_UART_AL004TN1-if00-port0
pin_map: arduino

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 1000
max_z_velocity: 10
max_z_accel: 100

#endstop x is broken
[homing_override]
gcode:
    G28 Y0
    G28 Z0
axes: x
set_position_x: 0

[bed_screws]
screw1: 0,0
screw1_fine_adjust: 155,155
screw2: 160,0
screw2_fine_adjust: 0,150
screw3: 85,170


#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 27.630
#*# pid_ki = 1.212
#*# pid_kd = 157.493
#*#
#*# [extruder1]
#*# control = pid
#*# pid_kp = 28.586
#*# pid_ki = 1.381
#*# pid_kd = 147.934
