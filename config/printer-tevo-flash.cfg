#  This file contains pin mappings for a Tevo Flash using a Bondtech BMG extruder.

[stepper_x]
step_pin: ar54
dir_pin: !ar55
enable_pin: !ar38
step_distance: .012491
endstop_pin: !ar3
position_endstop: -13
position_min: -13
position_max: 235
homing_speed: 50

[stepper_y]
step_pin: ar60
dir_pin: ar61
enable_pin: !ar56
step_distance: .012441
endstop_pin: !ar14
position_endstop: -3
position_min: -3
position_max: 235
homing_speed: 50

[stepper_z]
step_pin: ar46
dir_pin: ar48
enable_pin: !ar62
step_distance: .002520
position_max: 250
endstop_pin: probe:z_virtual_endstop
position_min: -2

[stepper_z1]
step_pin: ar36
dir_pin: ar34
enable_pin: !ar30
step_distance: .002520

[extruder]
step_pin: ar26
dir_pin: ar28
enable_pin: !ar24
step_distance: .002401
nozzle_diameter: 0.600
filament_diameter: 1.750
heater_pin: ar10
sensor_type: EPCOS 100K B57560G104F
sensor_pin: analog13
control: pid
pid_Kp=18.547
pid_Ki=0.788
pid_Kd=109.193
min_temp: 0
max_temp: 250
max_extrude_cross_section: 2.16
#   The above value of max_extrude_cross_section is for a 0.6mm nozzle.
#   Keep it disabled for a 0.4mm nozzle
pressure_advance: 0.61
#   The amount of raw filament to push into the extruder during
#   extruder acceleration. An equal amount of filament is retracted
#   during deceleration. It is measured in millimeters per
#   millimeter/second. The default is 0, which disables pressure
#   advance.
pressure_advance_lookahead_time: 0.010
#   A time (in seconds) to "look ahead" at future extrusion moves when
#   calculating pressure advance. This is used to reduce the
#   application of pressure advance during cornering moves that would
#   otherwise cause retraction followed immediately by pressure
#   buildup. This setting only applies if pressure_advance is
#   non-zero. The default is 0.010 (10 milliseconds).
#
# The remaining variables describe the extruder heater.

[heater_bed]
heater_pin: ar8
sensor_type: EPCOS 100K B57560G104F
sensor_pin: analog14
control: pid
pid_Kp=38.824
pid_Ki=0.539
pid_Kd=698.838
min_temp: 0
max_temp: 70

[fan]
pin: ar9

[mcu]
serial: /dev/ttyUSB0
pin_map: arduino

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 1000
max_z_velocity: 5
max_z_accel: 100

[display]
lcd_type: uc1701
cs_pin: ar25
a0_pin: ar27
encoder_pins: ^!ar31, ^!ar33
click_pin: ^!ar35
kill_pin: ar64

[bltouch]
sensor_pin: ar18
control_pin: ar11
pin_move_time: 0.200
pin_up_reports_not_triggered: True
pin_up_touch_mode_reports_triggered: True
x_offset: 0
y_offset: 18
z_offset: 1.64

# The homing_override section modifies the default G28 behavior
[homing_override]
set_position_z: 0
axes: z
gcode:
		G90
		G1 Z5 F600
		G28 X0 Y0
		G1 X118 Y118 F3600
		G28 Z5

# Mesh Bed Leveling. One may define a [bed_mesh] config section
# to enable move transformations that offset the z axis based
# on a mesh generated from probed points. Note that bed_mesh
# and bed_tilt are incompatible, both cannot be defined.  When
# using a probe to home the z-axis, it is recommended to define
# a [homing_override] section in printer.cfg to home toward the
# center of the print area.
#
#  Visual Examples:
#   bed_shape = rectangular, probe_count = 3,3:
#               x---x---x (max_point)
#               |
#               x---x---x
#                       |
#   (min_point) x---x---x
[bed_mesh]
#speed: 50
#   The speed (in mm/s) of non-probing moves during the
#   calibration. The default is 50.
#horizontal_move_z: 10
#   The height (in mm) that the head should be commanded to move to
#   just prior to starting a probe operation. The default is 5.
samples: 3
sample_retract_dist: 5
min_point: 5,0
max_point: 230,210
probe_count: 9,9
#   For 'rectangular' beds, this is a comma separate pair of integer
#   values (X,Y) defining the number of points to probe along each axis.
#   A single value is also valid, in which case that value will be applied
#   to both axes. 'Round' beds only accept a single integer value that is
#   applied to both axes.  The probe count must be odd for round beds.
#   Default is 3,3 for 'rectangular' beds, and 5 for 'round' beds.
#fade_start: 1.0
#   The gcode z position in which to start phasing out z-adjustment
#   when fade is enabled.  Default is 1.0.
#fade_end: 0.0
#   The gcode z position in which phasing out completes.  When set
#   to a value below fade_start, fade is disabled. It should be
#   noted that fade may add unwanted scaling along the z-axis of a
#   print.  If a user wishes to enable fade, a value of 10.0 is
#   recommended. Default is 0.0, which disables fade.
#fade_target:
#   The z position in which fade should converge. When this value is set
#   to a non-zero value it must be within the range of z-values in the mesh.
#   Users that wish to converge to the z homing position should set this to 0.
#   Default is the average z value of the mesh.
#split_delta_z: .025
#   The amount of Z difference (in mm) along a move that will
#   trigger a split. Default is .025.
#move_check_distance: 5.0
#   The distance (in mm) along a move to check for split_delta_z.
#   This is also the minimum length that a move can be split. Default
#   is 5.0.
#mesh_pps: 2,2
#   A comma separated pair of integers (X,Y) defining the number of
#   points per segment to interpolate in the mesh along each axis. A
#   "segment" can be defined as the space between each probed
#   point. The user may enter a single value which will be applied
#   to both axes.  Default is 2,2.
#algorithm: lagrange
#   The interpolation algorithm to use. May be either "lagrange"
#   or "bicubic". This option will not affect 3x3 grids, which
#   are forced to use lagrange sampling.  Default is lagrange.
#bicubic_tension: .2
#   When using the bicubic algorithm the tension parameter above
#   may be applied to change the amount of slope interpolated.
#   Larger numbers will increase the amount of slope, which
#   results in more curvature in the mesh. Default is .2.

# Heater cooling fans (one may define any number of sections with a
# "heater_fan" prefix). A "heater fan" is a fan that will be enabled
# whenever its associated heater is active. By default, a heater_fan
# has a shutdown_speed equal to max_power.
[heater_fan my_nozzle_fan]
pin: ar7
#max_power:
#shutdown_speed:
#cycle_time:
#hardware_pwm:
#kick_start_time:
#   See the "fan" section in example.cfg for a description of the
#   above parameters.
#heater: extruder
#   Name of the config section defining the heater that this fan is
#   associated with. If a comma separated list of heater names is
#   provided here, then the fan will be enabled when any of the given
#   heaters are enabled. The default is "extruder".
#heater_temp: 50.0
#   A temperature (in Celsius) that the heater must drop below before
#   the fan is disabled. The default is 50 Celsius.
#fan_speed: 1.0
#   The fan speed (expressed as a value from 0.0 to 1.0) that the fan
#   will be set to when its associated heater is enabled. The default
#   is 1.0

# M300 : Play tone, Beeper support, as commonly found on usual LCD displays
# i.e. RepRapDiscount 2004 Smart Controller, RepRapDiscount 12864 Full Graphic
# This defines a custom I/O pin and a custom GCODE macro
# Usage: M300 [P<ms>] [S<Hz>]      P is the tone duration, S the tone frequency.
# as it is based on a PWM duty cycle, the frequency won't be pitch perfect.
#
[output_pin BEEPER_pin]
pin: ar37
#  Beeper pin. This parameter must be provided.
#  ar37 is the default RAMPS/MKS pin.
pwm: True
#  A piezo beeper needs a PWM signal, a DC buzzer doesn't.
value: 0
#  Silent at power on, set to 1 if active low.
shutdown_value: 0
#  Disable at emergency shutdown (no PWM would be available anyway).
cycle_time: 0.001
#  PWM frequency : 0.001 = 1ms will give a base tone of 1kHz
scale: 1000
#  PWM parameter will be in the range of (0-1000 Hz).
#  Although not pitch perfect.

[gcode_macro M300]
default_parameter_S=1000
#  Allows for a default 1kHz tone if S is omitted
default_parameter_P=100
#  Allows for a default 10ms duration is P is omitted
gcode:  SET_PIN PIN=BEEPER_pin VALUE={S}
       G4 P{P}
       SET_PIN PIN=BEEPER_pin VALUE=0

[gcode_macro G29]
gcode: 
		G28
		G1 Z20 F600
		BED_MESH_CALIBRATE
		
		
[gcode_macro PETG_STARTCODE]
gcode:
		M107 ;turn off fan
		G28 ; home Y and Z axis end-stops
		G0 X10 Y10 F5000 ; Go to front
		G0 Z0.25 F3600; Drop to bed
		G92 E0 ; zero the extruded length
		G1 X70 E20 F500 ; Extrude 20mm of filament in a 6cm line
		G92 E0 ; zero the extruded length
		G1 E-3 F500 ; Retract a little
		G1 X80 F4000 ; Quickly wipe away from the filament line
		G1 Z0.3 ; Raise and begin printing

# [gcode_macro PETG_STARTCODE]
# gcode:
	# G28
	# G1 Z5 F3600

[gcode_macro PETG_ENDCODE]
gcode:
		G28 X0 ; home x axis
		G1 Y235 F2300 ; bring the bed forward
		M106 S0 ; turn off cooling fan
		M104 S0 ; turn off extruder
		M140 S0 ; turn off bed
		M84 ; disable motors
		M300
		

[gcode_macro TPU_STARTCODE]
gcode:
		M107 ;turn off fan
		G28 ; home Y and Z axis end-stops
		G0 X10 Y10 F5000 ; Go to front
		G0 Z0.25 F3600; Drop to bed
		G92 E0 ; zero the extruded length
		G1 X70 E20 F500 ; Extrude 20mm of filament in a 6cm line
		G92 E0 ; zero the extruded length
		G1 E-1 F500 ; Retract a little
		G1 X80 F4000 ; Quickly wipe away from the filament line
		G1 Z0.3 ; Raise and begin printing

# [gcode_macro TPU_STARTCODE]
# gcode:
	# G28
	# G1 Z5 F3600

[gcode_macro TPU_ENDCODE]
gcode:
		G28 X0 ; home x axis
		G1 Y235 F2300 ; bring the bed forward
		M106 S0 ; turn off cooling fan
		M104 S0 ; turn off extruder
		M140 S0 ; turn off bed
		M84 ; disable motors
		M300

