# This file contains common pin mappings for the 2022 Solvo
# sv04. To use this config, the firmware should be compiled for the
# STM32F103 with a "28KiB bootloader" and serial (on USART1 PA10/PA9)
# communication.

# Flash this firmware by copying "out/klipper.bin" to a SD card, renaming
# it firmware.bin, and turning on the printer with the card inserted.
# Klipper docs/Bootloaders.md file for more information.

[stepper_x]
step_pin: PD15
dir_pin: !PD14
enable_pin: !PC7
microsteps: 16
rotation_distance:  50
endstop_pin: !PD10
position_endstop: -60
position_min: -60
position_max: 360
homing_speed: 120
homing_positive_dir: False

[dual_carriage]
axis: x
step_pin: PE9
dir_pin: !PE8
enable_pin: !PE11
microsteps: 16
rotation_distance: 50
endstop_pin: !PE15
position_endstop: 300
position_max: 300
position_min: 60
homing_speed: 120
homing_positive_dir: True

[extruder]
step_pin: PD1
dir_pin: !PD0
enable_pin: !PD4
microsteps: 16
rotation_distance: 7.71
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA4
min_temp: 0
max_temp: 250
control = pid
pid_kp = 24.435
pid_ki = 1.442
pid_kd = 103.545

[extruder1]
step_pin: PB1
dir_pin: !PB0
enable_pin: !PE7
microsteps: 16
rotation_distance: 7
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA0
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA5
min_temp: 0
max_temp: 250
control = pid
pid_kp = 23.692
pid_ki = 1.6
pid_kd = 105.725

[stepper_y]
step_pin: PB7
dir_pin: PB6
enable_pin: !PB9
microsteps: 16
rotation_distance: 40
endstop_pin: !PE0
position_endstop: 0
position_max: 350
homing_speed: 120

[stepper_z]
step_pin: PB3
dir_pin: !PD7
enable_pin: !PB5
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_max: 400

[stepper_z1]
step_pin: PA7
dir_pin: !PA6
enable_pin: !PC5
rotation_distance: 8
microsteps: 16

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA3
control: pid
pid_kp: 66.429
pid_ki: 1.197
pid_kd: 921.707
min_temp: 0
max_temp: 135

[fan]
pin: PB14

[fan_generic extruder1_partfan]
pin: PB12

[bltouch]
sensor_pin: PD12
control_pin: PD13
z_offset: 2
x_offset: -1
y_offset: 30

[safe_z_home]
home_xy_position: 150, 150
speed: 80
z_hop: 10
z_hop_speed: 50

[z_tilt]
z_positions:
    -60,150
    370,150
points:
    15,150
    300,150
speed: 150
horizontal_move_z: 5
retries: 5
retry_tolerance: .003

[bed_mesh]
speed: 120
horizontal_move_z: 3
mesh_min: 36, 33
mesh_max: 265, 265
probe_count: 6

[screws_tilt_adjust]
screw1: 36, 1
screw1_name: front left screw
screw2: 276, 1
screw2_name: front right screw
screw3: 276, 230
screw3_name: rear right screw
screw4: 36, 230
screw4_name: rear left screw
horizontal_move_z: 10.
speed: 50.
screw_thread: CW-M3

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
baud: 115200
restart_method: command

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000
max_z_velocity: 5
max_z_accel: 100

# Helper script to park the carriage (called from T0 and T1 macros)
[gcode_macro PARK_extruder]
gcode:
    SAVE_GCODE_STATE NAME=park0
    G90
    G1 X0
    RESTORE_GCODE_STATE NAME=park0

# Activate the primary extruder
[gcode_macro T0]
gcode:
    PARK_{printer.toolhead.extruder}
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    SET_DUAL_CARRIAGE CARRIAGE=0
    SET_GCODE_OFFSET Y=0

[gcode_macro PARK_extruder1]
gcode:
    SAVE_GCODE_STATE NAME=park1
    G90
    G1 X200
    RESTORE_GCODE_STATE NAME=park1

[gcode_macro T1]
gcode:
    PARK_{printer.toolhead.extruder}
    ACTIVATE_EXTRUDER EXTRUDER=extruder1
    SET_DUAL_CARRIAGE CARRIAGE=1
    SET_GCODE_OFFSET Y=15
